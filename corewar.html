<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Browser Corewar</title>
        <script src="corewar.js" type="text/javascript"></script>
        <script src="MarsDisplay.js" type="text/javascript"></script>
        <script type="text/javascript">
            var width = 50;
            var height = 50;

            var mars;
            var marsDisplay;
            var running = false;
            var interval = 100;

            function start() {
                if (running) {
                    return;
                }

                running = true;

                setTimeout(
                    function gameStep() {
                        if (!mars.step()) {
                            stop();
                        }
                        marsDisplay.updateAll();
                        if (running) {
                            setTimeout(gameStep, interval);
                        }
                    },
                    interval
                );
            }

            function stop() {
                running = false;
            }

            function onload() {
                mars = new corewar.Mars(width * height, 10000);
                marsDisplay = new MarsDisplay(mars, "core", "cell", width, height);
            }

            function onstart() {
                start();
            }

            function onstep() {
                if (running) {
                    return;
                }

                mars.step();
                marsDisplay.updateAll();
            }

            function onstop() {
                stop();
            }

            function onreboot() {
                stop();
                mars.reboot();
                marsDisplay.updateAll();
                document.getElementById("programs").innerHTML = "";
            }

            function onspawn() {
                var program = document.getElementById("program").value;
                try {
                    var instructions = mars.compileProgram(program);
                } catch (e) {
                    alert("cannot compile: " + e);
                    return;
                }

                var owner = "owner" + mars.processes.length;
                mars.spawn(owner, instructions);
                marsDisplay.updateAll();

                var programs = document.getElementById("programs");
                var li = document.createElement("LI");
                var src = document.createTextNode("program of " + owner);
                li.appendChild(src);
                programs.appendChild(li);
            }

            function onslower() {
                interval += 50;
            }

            function onfaster() {
                interval = Math.max(50, interval - 50);
            }
        </script>
        <link href="corewar.css" rel="stylesheet" type="text/css">
    </head>
    <body onload="onload()">
        <div id="core"></div>
        <div id="ctrl">
            <button id="start" onclick="onstart()">Start</button>
            <button id="step" onclick="onstep()">Step</button>
            <button id="stop" onclick="onstop()">Stop</button>
            <button id="reboot" onclick="onreboot()">Reboot</button>
            <button id="slower" onclick="onslower()">Slower</button>
            <button id="faster" onclick="onfaster()">Faster</button>
            <div>
                <textarea id="program"></textarea>
                <button id="spawn" onclick="onspawn()">Spawn</button>
            </div>
            <ol id="programs"></ol>
            <div id="cell"></div>
        </div>
    </body>
</html>
